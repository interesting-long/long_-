C251 COMPILER V5.60.0,  ADC_Get                                                            12/09/25  17:03:03  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE ADC_Get
OBJECT MODULE PLACED IN .\out_file\ADC_Get.obj
COMPILER INVOKED BY: D:\keil\C251\BIN\C251.EXE ..\code\ADC_Get.c LARGE NOALIAS FLOAT64 WARNINGLEVEL(3) OPTIMIZE(3,SIZE) 
                    -BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_drive
                    -r;..\user;..\code) DEBUG PRINT(.\out_file\ADC_Get.lst) OBJECT(.\out_file\ADC_Get.obj) 

stmt  level    source

    1          #include "ADC_Get.h"
    2          
    3          unsigned int raw_adc_data[4][5]={0};        // 原始数据数组
    4          unsigned int filtered_adc[4]={0};           // 滤波后的ADC值数组
    5          
    6          //电感ADC通道和定时器初始化
    7          void ADC_GetInit(void)
    8          {   
    9   1          adc_init(ADC_CH0_P10,ADC_10BIT);
   10   1          adc_init(ADC_CH9_P01,ADC_10BIT);
   11   1          adc_init(ADC_CH13_P05,ADC_10BIT);
   12   1          adc_init(ADC_CH14_P06,ADC_10BIT);
   13   1      }
   14          
   15          //ADC采样+滤波
   16          unsigned int adc_filter(unsigned int *samples, unsigned char count)
   17          {
   18   1          unsigned int temp[5];
   19   1          unsigned char i,j;
   20   1          unsigned int swap;
   21   1          unsigned long sum = 0;
   22   1          
   23   1          if (count < 3) 
   24   1          {
   25   2              sum = 0;
   26   2              for (i = 0; i < count; i++) 
   27   2              {
   28   3                  sum += samples[i];
   29   3              }
   30   2              return (unsigned int)(sum / count);
   31   2          }
   32   1          
   33   1          for (i = 0; i < count; i++) 
   34   1          {
   35   2              temp[i] = samples[i];
   36   2          }
   37   1      
   38   1          for (i = 0; i < count - 1; i++) 
   39   1          {
   40   2              for (j = 0; j < count - i - 1; j++) 
   41   2              {
   42   3                  if (temp[j] > temp[j + 1]) 
   43   3                  {
   44   4                      swap = temp[j];
   45   4                      temp[j] = temp[j + 1];
   46   4                      temp[j + 1] = swap;
   47   4                  }
   48   3              }
   49   2          }
   50   1          
   51   1          sum = 0;
   52   1          for (i = 1; i < count - 1; i++) 
   53   1          {
   54   2              sum += temp[i];
   55   2          }
   56   1          
   57   1          return (unsigned int)(sum / (count - 2));
C251 COMPILER V5.60.0,  ADC_Get                                                            12/09/25  17:03:03  PAGE 2   

   58   1      }
   59          
   60          // ADC采样 和 滤波处理 函数
   61          void ADC_SampleAndFilter(void)
   62          {
   63   1          unsigned char sample_index=0;          // 采样循环计数器
   64   1          unsigned char channel_index=0;         // 通道循环计数器
   65   1          
   66   1          // 采集5次数据
   67   1          for (sample_index = 0; sample_index < 5; sample_index++) 
   68   1          {
   69   2              raw_adc_data[0][sample_index] = adc_convert(ADC_CH14_P06);
   70   2              raw_adc_data[1][sample_index] = adc_convert(ADC_CH13_P05);
   71   2              raw_adc_data[2][sample_index] = adc_convert(ADC_CH9_P01);
   72   2              raw_adc_data[3][sample_index] = adc_convert(ADC_CH0_P10);
   73   2          }
   74   1          
   75   1          // 滤波处理
   76   1          for (channel_index = 0; channel_index < 4; channel_index++) 
   77   1          {
   78   2              filtered_adc[channel_index] = adc_filter(raw_adc_data[channel_index], 5);
   79   2          }
   80   1              /*传递参数*/
   81   1              ADC_1 = (float)(filtered_adc[0]*1.0f);
   82   1              ADC_2 = (float)(filtered_adc[1]*1.0f);
   83   1              ADC_3 = (float)(filtered_adc[2]*1.0f);
   84   1              ADC_4 = (float)(filtered_adc[3]*1.0f);
   85   1      }
   86          
   87          
   88          //电池电压检测
   89          bit Battery_Init=0;
   90          unsigned int battery_get(void)
   91          {
   92   1          unsigned int BGV = (VREFH_ARR << 8) + VREFL_ARR;
   93   1          unsigned int battery_adc = 0;
   94   1          unsigned int ref_adc;
   95   1          unsigned int battery_v;
   96   1          unsigned char i;
   97   1          
   98   1          //通过全局变量标志位避免重复初始化
   99   1          if(Battery_Init==0)
  100   1          {
  101   2              adc_init(ADC_CH15_POWR,ADC_10BIT);
  102   2              adc_init(ADC_CH5_P15,ADC_10BIT);
  103   2              Battery_Init=1;
  104   2          }
  105   1          //采集三次取平均
  106   1          for (i = 0; i < 3; i++) 
  107   1          {
  108   2              battery_adc += adc_convert(ADC_CH5_P15);
  109   2          }
  110   1          battery_adc /= 3;                    
  111   1          
  112   1          ref_adc = adc_convert(ADC_CH15_POWR);
  113   1          
  114   1          battery_v = (unsigned int)((unsigned long)BGV * battery_adc / ref_adc);
  115   1          
  116   1          return battery_v*4;
  117   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       717     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
C251 COMPILER V5.60.0,  ADC_Get                                                            12/09/25  17:03:03  PAGE 3   

  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        48         12
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        58     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
