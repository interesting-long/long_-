C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE zf_driver_gpio
OBJECT MODULE PLACED IN .\out_file\zf_driver_gpio.obj
COMPILER INVOKED BY: D:\keil\C251\BIN\C251.EXE ..\..\libraries\zf_driver\zf_driver_gpio.c LARGE NOALIAS FLOAT64 WARNINGL
                    -EVEL(3) OPTIMIZE(3,SIZE) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device
                    -;..\..\libraries\zf_driver;..\user;..\code) DEBUG PRINT(.\out_file\zf_driver_gpio.lst) OBJECT(.\out_file\zf_driver_gpio.
                    -obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2          * AI8051U Opensourec Library ¼´£¨AI8051U ¿ªÔ´¿â£©ÊÇÒ»¸ö»ùÓÚ¹Ù·½ SDK ½Ó¿ÚµÄµÚÈý·½¿ªÔ´¿â
    3          * Copyright (c) 2022 SEEKFREE Öð·É¿Æ¼¼
    4          *
    5          * ±¾ÎÄ¼þÊÇSTC ¿ªÔ´¿âµÄÒ»²¿·Ö
    6          *
    7          * AI8051U ¿ªÔ´¿â ÊÇÃâ·ÑÈí¼þ
    8          * Äú¿ÉÒÔ¸ù¾Ý×ÔÓÉÈí¼þ»ù½ð»á·¢²¼µÄ GPL£¨GNU General Public License£¬¼´ GNUÍ¨ÓÃ¹«¹²Ðí¿ÉÖ¤£©µÄÌõ¿î
    9          * ¼´ GPL µÄµÚ3°æ£¨¼´ GPL3.0£©»ò£¨ÄúÑ¡ÔñµÄ£©ÈÎºÎºóÀ´µÄ°æ±¾£¬ÖØÐÂ·¢²¼ºÍ/»òÐÞ¸ÄËü
   10          *
   11          * ±¾¿ªÔ´¿âµÄ·¢²¼ÊÇÏ£ÍûËüÄÜ·¢»Ó×÷ÓÃ£¬µ«²¢Î´¶ÔÆä×÷ÈÎºÎµÄ±£Ö¤
   12          * ÉõÖÁÃ»ÓÐÒþº¬µÄÊÊÏúÐÔ»òÊÊºÏÌØ¶¨ÓÃÍ¾µÄ±£Ö¤
   13          * ¸ü¶àÏ¸½ÚÇë²Î¼û GPL
   14          *
   15          * ÄúÓ¦¸ÃÔÚÊÕµ½±¾¿ªÔ´¿âµÄÍ¬Ê±ÊÕµ½Ò»·Ý GPL µÄ¸±±¾
   16          * Èç¹ûÃ»ÓÐ£¬Çë²ÎÔÄ<https://www.gnu.org/licenses/>
   17          *
   18          * ¶îÍâ×¢Ã÷£º
   19          * ±¾¿ªÔ´¿âÊ¹ÓÃ GPL3.0 ¿ªÔ´Ðí¿ÉÖ¤Ð­Òé ÒÔÉÏÐí¿ÉÉêÃ÷ÎªÒëÎÄ°æ±¾
   20          * Ðí¿ÉÉêÃ÷Ó¢ÎÄ°æÔÚ libraries/doc ÎÄ¼þ¼ÐÏÂµÄ GPL3_permission_statement.txt ÎÄ¼þÖÐ
   21          * Ðí¿ÉÖ¤¸±±¾ÔÚ libraries ÎÄ¼þ¼ÐÏÂ ¼´¸ÃÎÄ¼þ¼ÐÏÂµÄ LICENSE ÎÄ¼þ
   22          * »¶Ó­¸÷Î»Ê¹ÓÃ²¢´«²¥±¾³ÌÐò µ«ÐÞ¸ÄÄÚÈÝÊ±±ØÐë±£ÁôÖð·É¿Æ¼¼µÄ°æÈ¨ÉùÃ÷£¨¼´±¾ÉùÃ÷£©
   23          *
   24          * ÎÄ¼þÃû³Æ          
   25          * ¹«Ë¾Ãû³Æ          ³É¶¼Öð·É¿Æ¼¼ÓÐÏÞ¹«Ë¾
   26          * °æ±¾ÐÅÏ¢          ²é¿´ libraries/doc ÎÄ¼þ¼ÐÄÚ version ÎÄ¼þ °æ±¾ËµÃ÷
   27          * ¿ª·¢»·¾³          MDK FOR C251
   28          * ÊÊÓÃÆ½Ì¨          AI8051U
   29          * µêÆÌÁ´½Ó          https://seekfree.taobao.com/
   30          *
   31          * ÐÞ¸Ä¼ÇÂ¼
   32          * ÈÕÆÚ              ×÷Õß           ±¸×¢
   33          * 2024-08-01        ´óW            first version
   34          *********************************************************************************************************
             -***********/
   35          
   36          #include "zf_common_debug.h"
   37          #include "zf_driver_gpio.h"
   38          
   39          
   40          
   41          
   42          
   43          
   44          // ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐè¹ØÐÄ¡£
   45          static void gpio_set_mode(gpio_pin_enum pin, gpio_mode_enum mode)
   46          {
   47   1              #define PXPU(pin)  (*(unsigned char volatile far *)(0x7efe10 + (pin >> 4 - 1)))
   48   1              #define PXPD(pin)  (*(unsigned char volatile far *)(0x7efe40 + (pin >> 4 - 1)))
   49   1      
   50   1              
   51   1          if(GPI_FLOATING_IN == mode || GPIO_NO_PULL == mode)
   52   1          {
   53   2              PXPU(pin) &= ~(1 << (pin & 0x0F));
   54   2              PXPD(pin) &= ~(1 << (pin & 0x0F));
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 2   

   55   2          }
   56   1          else if(GPI_PULL_DOWN == mode)
   57   1          {
   58   2              PXPD(pin) |= (1 << (pin & 0x0F));
   59   2          }
   60   1          else if(GPI_PULL_UP == mode || GPO_PUSH_PULL == mode)
   61   1          {
   62   2              PXPU(pin) |= (1 << (pin & 0x0F));
   63   2          }
   64   1              else if(GPO_OPEN_DTAIN == mode)
   65   1              {
   66   2                      switch(pin & 0xF0)
   67   2                      {
   68   3                              case IO_P00:
   69   3                              {
   70   4                      P0M1 |= (1 << (pin & 0xF));
   71   4                      P0M0 |= (1 << (pin & 0xF));
   72   4                              }
   73   3                              break;
   74   3      
   75   3                              case IO_P10:
   76   3                              {
   77   4                                      P1M1 |= (1 << (pin & 0xF));
   78   4                      P1M0 |= (1 << (pin & 0xF));
   79   4                              }
   80   3                              break;
   81   3                              
   82   3                              case IO_P20:
   83   3                              {
   84   4                                      P2M1 |= (1 << (pin & 0xF));
   85   4                      P2M0 |= (1 << (pin & 0xF));
   86   4                              }
   87   3                              break;
   88   3                              
   89   3                              case IO_P30:
   90   3                              {
   91   4                                      P3M1 |= (1 << (pin & 0xF));
   92   4                      P3M0 |= (1 << (pin & 0xF));
   93   4                              }
   94   3                              break;
   95   3                              
   96   3                              case IO_P40:
   97   3                              {
   98   4                                      P4M1 |= (1 << (pin & 0xF));
   99   4                      P4M0 |= (1 << (pin & 0xF));
  100   4                              }
  101   3                              break;
  102   3                              
  103   3                              case IO_P50:
  104   3                              {
  105   4                                      P5M1 |= (1 << (pin & 0xF));
  106   4                      P5M0 |= (1 << (pin & 0xF));
  107   4                              }
  108   3                              break;
  109   3                              default:
  110   3                              {
  111   4                              }       
  112   3                              break;
  113   3                      }
  114   2              }
  115   1              else
  116   1              {
  117   2                      zf_assert(0);
  118   2                      // ²ÎÊý²»Æ¥Åä
  119   2              }
  120   1      }
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 3   

  121          
  122          // ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐè¹ØÐÄ¡£
  123          void gpio_set_level_speed(gpio_pin_enum pin, gpio_speed_enum speed)
  124          {
  125   1          switch(pin & 0xF0)
  126   1          {
  127   2              case IO_P00:
  128   2              {
  129   3                  if(GPIO_SPEED_FAST == speed)
  130   3                  {
  131   4                                      P0SR &= ~(1<<(pin & 0x0F));
  132   4                  }
  133   3                  else if(GPIO_SPEED_LOW == speed)
  134   3                  {
  135   4                                      P0SR |= (1<<(pin & 0x0F));
  136   4                  }
  137   3                              else
  138   3                              {
  139   4                                      zf_assert(0);
  140   4                                      // Ã»ÓÐÕâ¸ö²ÎÊý
  141   4                              }
  142   3              }
  143   2              break;
  144   2              
  145   2              case IO_P10:
  146   2              {
  147   3                  if(GPIO_SPEED_FAST == speed)
  148   3                  {
  149   4                                      P1SR &= ~(1<<(pin & 0x0F));
  150   4                  }
  151   3                  else if(GPIO_SPEED_LOW == speed)
  152   3                  {
  153   4                                      P1SR |= (1<<(pin & 0x0F));
  154   4                  }
  155   3                              else
  156   3                              {
  157   4                                      zf_assert(0);
  158   4                                      // Ã»ÓÐÕâ¸ö²ÎÊý
  159   4                              }
  160   3              }
  161   2              break;
  162   2              
  163   2              case IO_P20:
  164   2              {
  165   3                  if(GPIO_SPEED_FAST == speed)
  166   3                  {
  167   4                                      P2SR &= ~(1<<(pin & 0x0F));
  168   4                  }
  169   3                  else if(GPIO_SPEED_LOW == speed)
  170   3                  {
  171   4                                      P2SR |= (1<<(pin & 0x0F));
  172   4                  }
  173   3                              else
  174   3                              {
  175   4                                      zf_assert(0);
  176   4                                      // Ã»ÓÐÕâ¸ö²ÎÊý
  177   4                              }
  178   3              }
  179   2              break;
  180   2              
  181   2              case IO_P30:
  182   2              {
  183   3                  if(GPIO_SPEED_FAST == speed)
  184   3                  {
  185   4                                      P3SR &= ~(1<<(pin & 0x0F));
  186   4                  }
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 4   

  187   3                  else if(GPIO_SPEED_LOW == speed)
  188   3                  {
  189   4                                      P3SR |= (1<<(pin & 0x0F));
  190   4                  }
  191   3                              else
  192   3                              {
  193   4                                      zf_assert(0);
  194   4                                      // Ã»ÓÐÕâ¸ö²ÎÊý
  195   4                              }
  196   3              }
  197   2              break;
  198   2              
  199   2              case IO_P40:
  200   2              {
  201   3                              if(GPIO_SPEED_FAST == speed)
  202   3                  {
  203   4                                      P4SR &= ~(1<<(pin & 0x0F));
  204   4                  }
  205   3                  else if(GPIO_SPEED_LOW == speed)
  206   3                  {
  207   4                                      P4SR |= (1<<(pin & 0x0F));
  208   4                  }
  209   3                              else
  210   3                              {
  211   4                                      zf_assert(0);
  212   4                                      // Ã»ÓÐÕâ¸ö²ÎÊý
  213   4                              }
  214   3              }
  215   2              break;
  216   2              
  217   2              case IO_P50:
  218   2              {
  219   3                  if(GPIO_SPEED_FAST == speed)
  220   3                  {
  221   4                                      P5SR &= ~(1<<(pin & 0x0F));
  222   4                  }
  223   3                  else if(GPIO_SPEED_LOW == speed)
  224   3                  {
  225   4                                      P5SR |= (1<<(pin & 0x0F));
  226   4                  }
  227   3                              else
  228   3                              {
  229   4                                      zf_assert(0);
  230   4                                      // Ã»ÓÐÕâ¸ö²ÎÊý
  231   4                              }
  232   3              }
  233   2              break;
  234   2              
  235   2              default:
  236   2              {
  237   3                              zf_assert(0);
  238   3                              // Ã»ÓÐÕâ¸öÒý½Å
  239   3              } break;
  240   2          }
  241   1      }
  242          
  243          
  244          // ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐè¹ØÐÄ¡£
  245          static void gpio_set_dir(gpio_pin_enum pin, gpio_dir_enum dir)
  246          {
  247   1          switch(pin & 0xF0)
  248   1          {
  249   2              case IO_P00:
  250   2              {
  251   3                  if(GPIO == dir)
  252   3                  {
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 5   

  253   4                      P0M1 &= ~(1 << (pin & 0xF));
  254   4                      P0M0 &= ~(1 << (pin & 0xF));
  255   4                  }
  256   3      //            else if(GPO_OPEN_DTAIN == dir)
  257   3      //            {
  258   3      //                P0M1 |= (1 << (pin & 0xF));
  259   3      //                P0M0 |= (1 << (pin & 0xF));
  260   3      //            }
  261   3                  else if(GPO == dir)
  262   3                  {
  263   4                      P0M1 &= ~(1 << (pin & 0xF));
  264   4                      P0M0 |= (1 << (pin & 0xF));
  265   4                  }
  266   3                  else if(GPI == dir)
  267   3                  {
  268   4                      P0M1 |= (1 << (pin & 0xF));
  269   4                      P0M0 &= ~(1 << (pin & 0xF));
  270   4                  }
  271   3              }
  272   2              break;
  273   2              
  274   2              case IO_P10:
  275   2              {
  276   3                  if(GPIO == dir)
  277   3                  {
  278   4                      P1M1 &= ~(1 << (pin & 0xF));
  279   4                      P1M0 &= ~(1 << (pin & 0xF));
  280   4                  }
  281   3      //            else if(GPO_OPEN_DTAIN == dir)
  282   3      //            {
  283   3      //                P1M1 |= (1 << (pin & 0xF));
  284   3      //                P1M0 |= (1 << (pin & 0xF));
  285   3      //            }
  286   3                  else if(GPO == dir)
  287   3                  {
  288   4                      P1M1 &= ~(1 << (pin & 0xF));
  289   4                      P1M0 |= (1 << (pin & 0xF));
  290   4                  }
  291   3                  else if(GPI == dir)
  292   3                  {
  293   4                      P1M1 |= (1 << (pin & 0xF));
  294   4                      P1M0 &= ~(1 << (pin & 0xF));
  295   4                  }
  296   3              }
  297   2              break;
  298   2              
  299   2              case IO_P20:
  300   2              {
  301   3                  if(GPIO == dir)
  302   3                  {
  303   4                      P2M1 &= ~(1 << (pin & 0xF));
  304   4                      P2M0 &= ~(1 << (pin & 0xF));
  305   4                  }
  306   3      //            else if(GPO_OPEN_DTAIN == dir)
  307   3      //            {
  308   3      //                P2M1 |= (1 << (pin & 0xF));
  309   3      //                P2M0 |= (1 << (pin & 0xF));
  310   3      //            }
  311   3                  else if(GPO == dir)
  312   3                  {
  313   4                      P2M1 &= ~(1 << (pin & 0xF));
  314   4                      P2M0 |= (1 << (pin & 0xF));
  315   4                  }
  316   3                  else if(GPI == dir)
  317   3                  {
  318   4                      P2M1 |= (1 << (pin & 0xF));
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 6   

  319   4                      P2M0 &= ~(1 << (pin & 0xF));
  320   4                  }
  321   3              }
  322   2              break;
  323   2              
  324   2              case IO_P30:
  325   2              {
  326   3                  if(GPIO == dir)
  327   3                  {
  328   4                      P3M1 &= ~(1 << (pin & 0xF));
  329   4                      P3M0 &= ~(1 << (pin & 0xF));
  330   4                  }
  331   3      //            else if(GPO_OPEN_DTAIN == dir)
  332   3      //            {
  333   3      //                P3M1 |= (1 << (pin & 0xF));
  334   3      //                P3M0 |= (1 << (pin & 0xF));
  335   3      //            }
  336   3                  else if(GPO == dir)
  337   3                  {
  338   4                      P3M1 &= ~(1 << (pin & 0xF));
  339   4                      P3M0 |= (1 << (pin & 0xF));
  340   4                  }
  341   3                  else if(GPI == dir)
  342   3                  {
  343   4                      P3M1 |= (1 << (pin & 0xF));
  344   4                      P3M0 &= ~(1 << (pin & 0xF));
  345   4                  }
  346   3              }
  347   2              break;
  348   2              
  349   2              case IO_P40:
  350   2              {
  351   3                  if(GPIO == dir)
  352   3                  {
  353   4                      P4M1 &= ~(1 << (pin & 0xF));
  354   4                      P4M0 &= ~(1 << (pin & 0xF));
  355   4                  }
  356   3      //            else if(GPO_OPEN_DTAIN == dir)
  357   3      //            {
  358   3      //                P4M1 |= (1 << (pin & 0xF));
  359   3      //                P4M0 |= (1 << (pin & 0xF));
  360   3      //            }
  361   3                  else if(GPO == dir)
  362   3                  {
  363   4                      P4M1 &= ~(1 << (pin & 0xF));
  364   4                      P4M0 |= (1 << (pin & 0xF));
  365   4                  }
  366   3                  else if(GPI == dir)
  367   3                  {
  368   4                      P4M1 |= (1 << (pin & 0xF));
  369   4                      P4M0 &= ~(1 << (pin & 0xF));
  370   4                  }
  371   3              }
  372   2              break;
  373   2              
  374   2              case IO_P50:
  375   2              {
  376   3                  if(GPIO == dir)
  377   3                  {
  378   4                      P5M1 &= ~(1 << (pin & 0xF));
  379   4                      P5M0 &= ~(1 << (pin & 0xF));
  380   4                  }
  381   3      //            else if(GPO_OPEN_DTAIN == dir)
  382   3      //            {
  383   3      //                P5M1 |= (1 << (pin & 0xF));
  384   3      //                P5M0 |= (1 << (pin & 0xF));
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 7   

  385   3      //            }
  386   3                  else if(GPO == dir)
  387   3                  {
  388   4                      P5M1 &= ~(1 << (pin & 0xF));
  389   4                      P5M0 |= (1 << (pin & 0xF));
  390   4                  }
  391   3                  else if(GPI == dir)
  392   3                  {
  393   4                      P5M1 |= (1 << (pin & 0xF));
  394   4                      P5M0 &= ~(1 << (pin & 0xF));
  395   4                  }
  396   3              }
  397   2              break;
  398   2              
  399   2              default:
  400   2              {
  401   3                              zf_assert(0);
  402   3                              // Ã»ÓÐÕâ¸öÒý½Å
  403   3              } break;
  404   2          }
  405   1      }
  406          
  407          //-------------------------------------------------------------------------------------------------------
             -------------
  408          // º¯Êý¼ò½é     GPIO×´Ì¬»ñÈ¡
  409          // ²ÎÊýËµÃ÷     pin         Ñ¡ÔñµÄÒý½Å (¿ÉÑ¡Ôñ·¶Î§ÓÉ zf_driver_gpio.h ÄÚgpio_pin_enumÃ¶¾ÙÖµÈ·¶¨)
  410          // ·µ»Ø²ÎÊý     uint8       0£ºµÍµçÆ½ 1£º¸ßµçÆ½
  411          // Ê¹ÓÃÊ¾Àý     uint8 status = gpio_get_level(IO_P00);//»ñÈ¡P00Òý½ÅµçÆ½
  412          //-------------------------------------------------------------------------------------------------------
             -------------
  413          uint8 gpio_get_level(gpio_pin_enum pin)
  414          {
  415   1          uint8 status = 0;
  416   1          
  417   1          switch(pin & 0xF0)
  418   1          {
  419   2              case IO_P00:
  420   2              {
  421   3                  status = P0 & (1 << (pin & 0x0F));
  422   3              }
  423   2              break;
  424   2              
  425   2              case IO_P10:
  426   2              {
  427   3                  status = P1 & (1 << (pin & 0x0F));
  428   3              }
  429   2              break;
  430   2              
  431   2              case IO_P20:
  432   2              {
  433   3                  status = P2 & (1 << (pin & 0x0F));
  434   3              }
  435   2              break;
  436   2              
  437   2              case IO_P30:
  438   2              {
  439   3                  status = P3 & (1 << (pin & 0x0F));
  440   3              }
  441   2              break;
  442   2              
  443   2              case IO_P40:
  444   2              {
  445   3                  status = P4 & (1 << (pin & 0x0F));
  446   3              }
  447   2              break;
  448   2              
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 8   

  449   2              case IO_P50:
  450   2              {
  451   3                  status = P5 & (1 << (pin & 0x0F));
  452   3              }
  453   2              break;
  454   2              
  455   2              default:
  456   2              {
  457   3                              zf_assert(0);
  458   3                              // Ã»ÓÐÕâ¸öÒý½Å
  459   3              } break;
  460   2          }
  461   1          
  462   1          return status ? 1 : 0;
  463   1      }
  464          
  465          //-------------------------------------------------------------------------------------------------------
             -------------
  466          // º¯Êý¼ò½é     GPIOÊä³öÉèÖÃ
  467          // ²ÎÊýËµÃ÷     pin         Òý½ÅºÅÑ¡ÔñµÄÒý½Å (¿ÉÑ¡Ôñ·¶Î§ÓÉ common.h ÄÚGPIO_PIN_enumÃ¶¾ÙÖµÈ·¶¨)
  468          // ²ÎÊýËµÃ÷     dat         Òý½ÅµÄµçÆ½×´Ì¬£¬Êä³öÊ±ÓÐÐ§ 0£ºµÍµçÆ½ 1£º¸ßµçÆ½
  469          // ·µ»Ø²ÎÊý     void
  470          // Ê¹ÓÃÊ¾Àý     gpio_set_level(D0, 0);//D0Êä³öµÍµçÆ½
  471          //-------------------------------------------------------------------------------------------------------
             -------------
  472          void gpio_set_level(gpio_pin_enum pin, uint8 dat)
  473          {
  474   1          switch(pin & 0xF0)
  475   1          {
  476   2              case IO_P00:
  477   2              {
  478   3                              if(dat)
  479   3                              {
  480   4                                      P0 |= (1 << (pin & 0x0F));
  481   4                              }
  482   3                              else
  483   3                              {
  484   4                                      P0 &= ~(1 << (pin & 0x0F));
  485   4                              }
  486   3              }
  487   2              break;
  488   2              
  489   2              case IO_P10:
  490   2              {
  491   3                              if(dat)
  492   3                              {
  493   4                                      P1 |= (1 << (pin & 0x0F));
  494   4                              }
  495   3                              else
  496   3                              {
  497   4                                      P1 &= ~(1 << (pin & 0x0F));
  498   4                              }
  499   3              }
  500   2              break;
  501   2              
  502   2              case IO_P20:
  503   2              {
  504   3                              if(dat)
  505   3                              {
  506   4                                      P2 |= (1 << (pin & 0x0F));
  507   4                              }
  508   3                              else
  509   3                              {
  510   4                                      P2 &= ~(1 << (pin & 0x0F));
  511   4                              }
  512   3              }
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 9   

  513   2              break;
  514   2              
  515   2              case IO_P30:
  516   2              {
  517   3                              if(dat)
  518   3                              {
  519   4                                      P3 |= (1 << (pin & 0x0F));
  520   4                              }
  521   3                              else
  522   3                              {
  523   4                                      P3 &= ~(1 << (pin & 0x0F));
  524   4                              }
  525   3              }
  526   2              break;
  527   2              
  528   2              case IO_P40:
  529   2              {
  530   3                              if(dat)
  531   3                              {
  532   4                                      P4 |= (1 << (pin & 0x0F));
  533   4                              }
  534   3                              else
  535   3                              {
  536   4                                      P4 &= ~(1 << (pin & 0x0F));
  537   4                              }
  538   3              }
  539   2              break;
  540   2              
  541   2              case IO_P50:
  542   2              {
  543   3                              if(dat)
  544   3                              {
  545   4                                      P5 |= (1 << (pin & 0x0F));
  546   4                              }
  547   3                              else
  548   3                              {
  549   4                                      P5 &= ~(1 << (pin & 0x0F));
  550   4                              }
  551   3              }
  552   2              break;
  553   2              
  554   2              default:
  555   2              {
  556   3                              zf_assert(0);
  557   3                              // Ã»ÓÐÕâ¸öÒý½Å
  558   3              } break;
  559   2          }
  560   1      }
  561          
  562          //-------------------------------------------------------------------------------------------------------
             -------------
  563          // º¯Êý¼ò½é     GPIOÊä³öÉèÖÃ
  564          // ²ÎÊýËµÃ÷     pin         Òý½ÅºÅÑ¡ÔñµÄÒý½Å (¿ÉÑ¡Ôñ·¶Î§ÓÉ common.h ÄÚGPIO_PIN_enumÃ¶¾ÙÖµÈ·¶¨)
  565          // ²ÎÊýËµÃ÷     dat         Òý½ÅµÄµçÆ½×´Ì¬£¬Êä³öÊ±ÓÐÐ§ 0£ºµÍµçÆ½ 1£º¸ßµçÆ½
  566          // ·µ»Ø²ÎÊý     void
  567          // Ê¹ÓÃÊ¾Àý     gpio_set_level(D0, 0);//D0Êä³öµÍµçÆ½
  568          //-------------------------------------------------------------------------------------------------------
             -------------
  569          void gpio_toggle_level(gpio_pin_enum pin)
  570          {
  571   1              if(gpio_get_level(pin))
  572   1              {
  573   2                      gpio_low(pin);
  574   2              }
  575   1              else
  576   1              {
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 10  

  577   2                      gpio_high(pin);
  578   2              }
  579   1      }
  580          
  581          //-------------------------------------------------------------------------------------------------------
             -------------
  582          // º¯Êý¼ò½é     GPIOÉèÖÃ¸ß×èÊäÈë
  583          // ²ÎÊýËµÃ÷     pin         Òý½ÅºÅÑ¡ÔñµÄÒý½Å (¿ÉÑ¡Ôñ·¶Î§ÓÉ common.h ÄÚGPIO_PIN_enumÃ¶¾ÙÖµÈ·¶¨)
  584          // ·µ»Ø²ÎÊý     void
  585          // Ê¹ÓÃÊ¾Àý     
  586          //-------------------------------------------------------------------------------------------------------
             -------------
  587          void gpio_set_impedance(gpio_pin_enum pin)
  588          {
  589   1          switch(pin & 0xF0)
  590   1          {
  591   2              case IO_P00:
  592   2              {
  593   3                              P0M1 |=  (1 << (pin & 0xF));
  594   3                              P0M0 &= ~(1 << (pin & 0xF));
  595   3              }
  596   2              break;
  597   2              
  598   2              case IO_P10:
  599   2              {
  600   3                              P1M1 |=  (1 << (pin & 0xF));
  601   3                              P1M0 &= ~(1 << (pin & 0xF));
  602   3              }
  603   2              break;
  604   2              
  605   2              case IO_P20:
  606   2              {
  607   3                              P2M1 |=  (1 << (pin & 0xF));
  608   3                              P2M0 &= ~(1 << (pin & 0xF));;
  609   3              }
  610   2              break;
  611   2              
  612   2              case IO_P30:
  613   2              {
  614   3                              P3M1 |=  (1 << (pin & 0xF));
  615   3                              P3M0 &= ~(1 << (pin & 0xF));
  616   3              }
  617   2              break;
  618   2              
  619   2              case IO_P40:
  620   2              {
  621   3                              P4M1 |=  (1 << (pin & 0xF));
  622   3                              P4M0 &= ~(1 << (pin & 0xF));
  623   3              }
  624   2              break;
  625   2              
  626   2              case IO_P50:
  627   2              {
  628   3                              P5M1 |=  (1 << (pin & 0xF));
  629   3                              P5M0 &= ~(1 << (pin & 0xF));
  630   3              }
  631   2              break;
  632   2              
  633   2              default:
  634   2              {
  635   3                              zf_assert(0);
  636   3                              // Ã»ÓÐÕâ¸öÒý½Å
  637   3              } break;
  638   2          }
  639   1      }
  640          
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 11  

  641          //-------------------------------------------------------------------------------------------------------
             -------------
  642          // º¯Êý¼ò½é     GPIO³õÊ¼»¯
  643          // ²ÎÊýËµÃ÷     pin         Ñ¡ÔñµÄÒý½Å (¿ÉÑ¡Ôñ·¶Î§ÓÉ common.h ÄÚGPIO_PIN_enumÃ¶¾ÙÖµÈ·¶¨)
  644          // ²ÎÊýËµÃ÷     dir         Òý½ÅµÄ·½Ïò   Êä³ö£ºGPO   ÊäÈë£ºGPI
  645          // ²ÎÊýËµÃ÷     dat         Òý½Å³õÊ¼»¯Ê±ÉèÖÃµÄµçÆ½×´Ì¬£¬Êä³öÊ±ÓÐÐ§ 0£ºµÍµçÆ½ 1£º¸ßµçÆ½
  646          // ²ÎÊýËµÃ÷     pinconf     Òý½ÅÅäÖÃ£¨¿ÉÉèÖÃ²ÎÊýÓÉzf_gpio.hÎÄ¼þÄÚGPIOSPEED_enumÓëGPIOMODE_enumÃ¶¾ÙÖµÈ·¶¨£
             -¬¶à¸öÌõ¼þÊ¹ÓÃ | Ïà»ò£©
  647          // ·µ»Ø²ÎÊý     void
  648          // Ê¹ÓÃÊ¾Àý     gpio_init(D0, GPO, 1, GPIO_PIN_CONFIG);//D0³õÊ¼»¯ÎªGPIO¹¦ÄÜ¡¢Êä³öÄ£Ê½¡¢Êä³ö¸ßµçÆ½¡¢ËÙ¶È10
             -0MHZ ÍÆÍìÊä³ö
  649          //-------------------------------------------------------------------------------------------------------
             -------------
  650          void gpio_init(gpio_pin_enum pin, gpio_dir_enum dir, const uint8 dat, gpio_mode_enum mode)
  651          {
  652   1              zf_assert(dir == (mode >> 4));
  653   1      
  654   1              if(dir == GPIO)
  655   1              {
  656   2                      gpio_set_dir(pin, GPIO);
  657   2                      gpio_set_mode(pin, mode);
  658   2              }
  659   1              else if(dir == GPI)
  660   1              {
  661   2                      if(mode == GPI_IMPEDANCE)
  662   2                      {
  663   3                              gpio_set_impedance(pin);
  664   3                      }
  665   2                      else
  666   2                      {
  667   3                              gpio_set_dir(pin, GPI);
  668   3                              gpio_set_mode(pin, mode);
  669   3                      }
  670   2              }
  671   1              else if(dir == GPO)
  672   1              {
  673   2                      if(GPO_PUSH_PULL == mode)
  674   2                      {
  675   3                              gpio_set_dir(pin, GPO);
  676   3                              gpio_set_mode(pin, GPI_PULL_UP);
  677   3                      }
  678   2                      else if(GPO_OPEN_DTAIN == mode)
  679   2                      {
  680   3                              gpio_set_mode(pin, GPO_OPEN_DTAIN);
  681   3                      }
  682   2              }
  683   1              gpio_set_level(pin, dat);
  684   1      }
  685          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      3343     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------          3
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
C251 COMPILER V5.60.0,  zf_driver_gpio                                                     13/10/25  20:07:43  PAGE 12  

  const size           =    ------     ------
  hconst size          =        43     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
